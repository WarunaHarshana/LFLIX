<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="color-scheme" content="dark">
    <title>LFLIX</title>
    <style>
        * {
            box-sizing: border-box;
        }
        body {
            background-color: #0f0f0f;
            color: #ffffff;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
        }
        .container {
            width: 100%;
            max-width: 400px;
            text-align: center;
        }
        .logo {
            color: #e50914;
            font-size: 3rem;
            margin-bottom: 10px;
            font-weight: 800;
        }
        .subtitle {
            color: #a3a3a3;
            margin-bottom: 30px;
            font-size: 1rem;
        }
        .input-group {
            margin-bottom: 20px;
        }
        input {
            width: 100%;
            padding: 15px;
            background: #333;
            border: 1px solid #444;
            border-radius: 8px;
            color: white;
            font-size: 16px;
            text-align: center;
            transition: border-color 0.2s;
        }
        input:focus {
            outline: none;
            border-color: #e50914;
        }
        input::placeholder {
            color: #666;
        }
        .hint {
            font-size: 12px;
            color: #666;
            margin-top: 8px;
        }
        button {
            width: 100%;
            padding: 16px;
            background-color: #e50914;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.2s;
        }
        button:hover {
            background-color: #f40612;
        }
        button:disabled {
            background-color: #666;
            cursor: not-allowed;
        }
        .last-server {
            margin-top: 20px;
            padding: 12px;
            background: #1a1a1a;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .last-server:hover {
            background: #252525;
        }
        .last-server-label {
            font-size: 11px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }
        .last-server-ip {
            font-size: 14px;
            color: #fff;
        }
        .error {
            color: #e50914;
            font-size: 14px;
            margin-top: 10px;
            padding: 10px;
            background: rgba(229, 9, 20, 0.1);
            border-radius: 8px;
            display: none;
        }
        .error.show {
            display: block;
        }
        .loading {
            display: none;
            margin-top: 20px;
        }
        .loading.show {
            display: block;
        }
        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #333;
            border-top-color: #e50914;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .help {
            margin-top: 30px;
            padding: 16px;
            background: #1a1a1a;
            border-radius: 8px;
            text-align: left;
        }
        .help-title {
            font-size: 12px;
            font-weight: bold;
            color: #888;
            margin-bottom: 8px;
            text-transform: uppercase;
        }
        .help-text {
            font-size: 13px;
            color: #666;
            line-height: 1.5;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="logo">LFLIX</h1>
        <p class="subtitle">Connect to your LFLIX Server</p>
        
        <div class="input-group">
            <input 
                type="text" 
                id="serverInput" 
                placeholder="192.168.1.50:3000"
                autocomplete="off"
                autocorrect="off"
                autocapitalize="off"
            >
            <div class="hint">Enter your PC's IP address with port</div>
        </div>
        
        <button id="connectBtn" onclick="connect()">Connect</button>
        
        <div id="lastServer" class="last-server" style="display: none;" onclick="connectToLast()">
            <div class="last-server-label">Last Connected</div>
            <div class="last-server-ip" id="lastServerIp"></div>
        </div>
        
        <div id="error" class="error"></div>
        
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <div style="color: #666; font-size: 14px;">Connecting...</div>
        </div>

        <div class="help">
            <div class="help-title">How to find your IP</div>
            <div class="help-text">
                On your PC running LFLIX, click "Mobile Connect" button and scan the QR code, 
                or check the IP displayed there. Make sure your phone and PC are on the same WiFi network.
            </div>
        </div>
    </div>

    <script>
        const serverInput = document.getElementById('serverInput');
        const connectBtn = document.getElementById('connectBtn');
        const errorDiv = document.getElementById('error');
        const loadingDiv = document.getElementById('loading');
        const lastServerDiv = document.getElementById('lastServer');
        const lastServerIpDiv = document.getElementById('lastServerIp');

        // Load last server
        const storedServer = localStorage.getItem('lflix_server_url');
        if (storedServer) {
            // Check if we have server in URL (from redirect) - if not, auto-redirect to app
            const urlParams = new URLSearchParams(window.location.search);
            if (!urlParams.get('server')) {
                // Auto-redirect to app with stored server
                window.location.href = `./app/?server=${encodeURIComponent(storedServer)}`;
            } else {
                // Server param exists, show last server button
                try {
                    const url = new URL(storedServer);
                    lastServerIpDiv.textContent = url.host;
                    lastServerDiv.style.display = 'block';
                } catch (e) {
                    localStorage.removeItem('lflix_server_url');
                }
            }
        }

        // Focus input
        serverInput.focus();

        function showError(msg) {
            errorDiv.textContent = msg;
            errorDiv.classList.add('show');
            loadingDiv.classList.remove('show');
            connectBtn.disabled = false;
        }

        function hideError() {
            errorDiv.classList.remove('show');
        }

        async function connect() {
            hideError();
            connectBtn.disabled = true;
            loadingDiv.classList.add('show');

            let input = serverInput.value.trim();
            if (!input) {
                showError('Please enter a server address');
                return;
            }

            // Build URL
            let serverUrl;
            try {
                if (!input.startsWith('http')) {
                    input = 'http://' + input;
                }
                serverUrl = new URL(input);
            } catch (e) {
                showError('Invalid address format');
                return;
            }

            // Test connection
            try {
                const testUrl = `${serverUrl.origin}/api/ping`;
                const response = await fetch(testUrl, { 
                    method: 'GET',
                    signal: AbortSignal.timeout(5000)
                });
                
                if (!response.ok) {
                    throw new Error('Server not responding');
                }
            } catch (e) {
                showError('Cannot connect to server. Check the IP and make sure LFLIX is running on your PC.');
                return;
            }

            // Save and redirect
            localStorage.setItem('lflix_server_url', serverUrl.origin);
            
            // Redirect to app with server URL
            // App is exported to app/ subfolder
            window.location.href = `./app/?server=${encodeURIComponent(serverUrl.origin)}`;
        }

        function connectToLast() {
            const stored = localStorage.getItem('lflix_server_url');
            if (stored) {
                serverInput.value = stored.replace(/^https?:\/\//, '');
                connect();
            }
        }

        // Allow Enter key
        serverInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') connect();
        });

        // Clear error on input
        serverInput.addEventListener('input', hideError);
    </script>
</body>
</html>
